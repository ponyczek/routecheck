---
import AuthenticatedLayout from "@/layouts/AuthenticatedLayout.astro";
import { AlertsAndTelemetryViewWithProvider } from "@/components/settings/AlertsAndTelemetryViewWithProvider";
import type { TelemetryAggregatesDTO, EmailLogDTO } from "@/types";

// Get Supabase client from middleware (Astro.locals is set by middleware)
const supabase = Astro.locals.supabase;

// Check authentication
const {
  data: { session },
  error: sessionError,
} = await supabase.auth.getSession();

if (sessionError || !session) {
  return Astro.redirect("/signin?returnUrl=/settings/alerts");
}

// Fetch initial data server-side (optional - for better UX)
let telemetryData: TelemetryAggregatesDTO | null = null;
let emailLogs: EmailLogDTO[] | null = null;

// Fetch telemetry data
try {
  const to = new Date();
  const from = new Date();
  from.setDate(from.getDate() - 7);

  const telemetryParams = new URLSearchParams({
    eventType: "FORM_SUBMIT",
    bucket: "day",
    from: from.toISOString().split("T")[0],
    to: to.toISOString().split("T")[0],
  });

  const telemetryResponse = await fetch(`${Astro.url.origin}/api/telemetry?${telemetryParams}`, {
    headers: {
      Cookie: Astro.request.headers.get("Cookie") || "",
    },
  });

  if (telemetryResponse.ok) {
    telemetryData = await telemetryResponse.json();
  }
} catch (err) {
  console.error("Failed to fetch telemetry data:", err);
  // Non-critical error - component will fetch again client-side
}

// Fetch email logs
try {
  const logsParams = new URLSearchParams({
    limit: "10",
    sortBy: "sentAt",
    sortDir: "desc",
  });

  const logsResponse = await fetch(`${Astro.url.origin}/api/email-logs?${logsParams}`, {
    headers: {
      Cookie: Astro.request.headers.get("Cookie") || "",
    },
  });

  if (logsResponse.ok) {
    const logsData = await logsResponse.json();
    emailLogs = logsData.items;
  }
} catch (err) {
  console.error("Failed to fetch email logs:", err);
  // Non-critical error - component will fetch again client-side
}
---

<AuthenticatedLayout
  title="Alerty i Telemetria - Ustawienia - RouteCheck"
  description="Zarządzaj powiadomieniami e-mail i przeglądaj metryki użyteczności formularza kierowcy"
>
  <div class="container mx-auto space-y-6 p-6">
    <!-- Settings navigation tabs -->
    <div class="flex gap-4 border-b border-border">
      <a
        href="/settings/profile"
        class="border-b-2 border-transparent px-4 py-2 text-sm font-medium text-muted-foreground hover:text-foreground"
      >
        Profil
      </a>
      <a href="/settings/alerts" class="border-b-2 border-primary px-4 py-2 text-sm font-medium text-primary">
        Alerty
      </a>
      <a
        href="/settings/account"
        class="border-b-2 border-transparent px-4 py-2 text-sm font-medium text-muted-foreground hover:text-foreground"
      >
        Konto
      </a>
    </div>

    <!-- Alerts and Telemetry view -->
    <AlertsAndTelemetryViewWithProvider client:load initialTelemetryData={telemetryData} initialEmailLogs={emailLogs} />
  </div>
</AuthenticatedLayout>
